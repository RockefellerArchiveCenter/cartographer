{% extends "maps/base.html" %}
{% load mptt_tags %}

{% block title %}{% if object.pk %}Edit {{object.title}} Map{% else %}Create New Map{% endif %}{% endblock %}

{% block content %}
<div class="row">
	<div class="col-12">
		<form action="" method="post">
			{% csrf_token %}
			{{form.management_form}}
			{{form.non_form_errors}}
			{% for hidden in form.hidden_fields %}
				{{ hidden }}
			{% endfor %}

			{% for field in form.visible_fields %}
				{% include 'maps/form_fields.html' %}
			{% endfor %}

			{% if object.pk and not object.components.all %}
			<button type="button" class="btn btn-sm btn-outline-primary create-component" data-toggle="modal" data-target="#component_create_modal" data-map="{{object.pk}}">
			  add child
			</button>
			{% endif %}

			{% if object.components.all %}
			<div class="row">
				{% recursetree object.components.all %}
					<div class="col-12 border-top">
						<div class="m-1 row">
							<div class="title col">
								<p class="mb-0">{{ node.title }}</p>
							</div>
							<div class="buttons col">
								<div class="btn-group btn-group-sm" role="group" aria-label="Add additional components">
									<button class="btn btn-outline-primary create-component" data-toggle="modal" data-target="#component_create_modal" data-map="{{object.pk}}" data-parent="{{node.parent.pk}}">add sibling</button>
									<button class="btn btn-outline-primary create-component" data-toggle="modal" data-target="#component_create_modal" data-map="{{object.pk}}" data-parent="{{node.pk}}">add child</button>
								</div>
								<button class="btn btn-sm btn-danger delete-component" data-toggle="modal" data-target="#component_delete_modal" data-object="{{node.pk}}">delete</button>
							</div>
						</div>
							{% if not node.is_leaf_node %}
									<div class="children">
										{{ children }}
				          </div>
			        {% endif %}
			     </div>
			   {% endrecursetree %}
			</div>
			{% endif %}

  		<div class="row mt-4">
  			<div class="col-12">
  				<button type="submit" class="btn btn-primary">Submit</button>
  				<a href="{% url 'app:map-list' %}" class="btn btn-danger">Cancel</a>
  			</div>
  		</div>

  	</form>
  </div>
</div>

{% include "maps/component_create_modal.html" %}
{% include "maps/component_delete_modal.html" %}

{% endblock %}

{% block extra_js %}
<script type="text/javascript">
	$('.create-component').on('click', function(e){
		e.preventDefault();
		$('#component_create_modal input[name=parent]').val($(this).data('parent'))
		$('#component_create_modal input[name=map]').val($(this).data('map'))
	})

	$('.delete-component').on('click', function(e){
		e.preventDefault();
		$('#component_delete_modal input[name=object]').val($(this).data('object'))
	})

	$('#component_create_modal button.save').on('click', function(){
		var form = $('#component_create_modal form')
		var title = form.find('input[name=title]').val()
		var uri = form.find('#component_create_modal input[name=archivesspace_uri]').val()
		var parent = form.find('#component_create_modal input[name=parent]').val()
		var map = form.find('#component_create_modal input[name=map]').val()
		if (title || uri) {
			$.ajax({
				type: form.attr('method'),
				url: form.attr('action'),
				data: form.serialize(),
				context: form,
				success: function(data, status) {
					$('#component_create_modal').modal('hide');
					location.reload();
				}
			})
		} else {
			form.find('input[type=text]').each(function(){
				$(this).addClass('is-invalid')
			})
			form.prepend('<div class="alert alert-danger">You must enter either a title or an ArchivesSpace URI.</div>')
			return false
		}
	});

	$('#component_delete_modal button.save').on('click', function(){
		var form = $('#component_delete_modal form')
		$.ajax({
			type: form.attr('method'),
			url: form.attr('action'),
			data: form.serialize(),
			context: form,
			success: function(data, status) {
				$('#component_delete_modal').modal('hide');
				location.reload();
			}
		})
	});

</script>
{% endblock %}
